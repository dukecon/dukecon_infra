version: "2"

networks:
  default:
  inspectit:
    external: true
  monitoring:
    external: true

services:
  dukecon-pwa:
    image: dukecon/dukecon-pwa:<%= @dukecon_instance_label %>
    restart: always

  dukecon-admin-client:
    image: dukecon/dukecon-admin-client:<%= @dukecon_instance_label %>
    restart: always

  dukecon-postgres:
    image: "postgres:<%= @dukecon_postgres_version %>"
    restart: always
    environment:
      - "POSTGRES_USER=dukecon"
      - "POSTGRES_PASSWORD=dukecon"
    ports:
      - "127.0.0.1:<%= @dukecon_instance_postgres_port %>:5432"
    volumes:
      - "/data/dukecon/<%= @dukecon_instance_name %>/postgresql/data:/var/lib/postgresql/data"

  dukecon-server:
    image: dukecon/dukecon-server:<%= @dukecon_instance_label %>
    restart: always
    container_name: dukecon-server-<%= @dukecon_instance_name %>
    depends_on:
      - dukecon-postgres
    links:
      - dukecon-postgres:postgres
    environment:
      - "JAVA_OPTS=-XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/dukecon/heapdumps <%= @inspectit_agent %> -Dinspectit.agent.name=<%= @dukecon_instance_name %>"
      - "SPRING_CONFIG_ADDITIONAL_LOCATION=/opt/dukecon/config"
      - "SPRING_PROFILES_ACTIVE=<%= @dukecon_instance_name %>,postgresql,docker"
    networks:
      - default
      - inspectit
      - monitoring
    ports:
      - "127.0.0.1:<%= @dukecon_instance_internal_port %>:8080"
    volumes:
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/cache:/opt/dukecon/cache"
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/config:/opt/dukecon/config"
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/heapdumps:/opt/dukecon/heapdumps"
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/logs:/opt/dukecon/logs"
      - "/opt/inspectit:/opt/inspectit"
      - "/etc/ssl/certs/java/cacerts:/etc/ssl/certs/java/cacerts"

<% if @dukecon_instance_feedback_port != "" -%>
  dukecon-feedback:
    image: dukecon/dukecon-feedback:<%= @dukecon_instance_label %>
    restart: always
    container_name: dukecon-feedback-<%= @dukecon_instance_name %>
    depends_on:
      - dukecon-postgres
    links:
      - dukecon-postgres:postgres
    environment:
      - "JAVA_OPTS=-XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/dukecon/heapdumps <%= @inspectit_agent %> -Dinspectit.agent.name=feedback-<%= @dukecon_instance_name %>"
      - "SPRING_CONFIG_ADDITIONAL_LOCATION=/opt/dukecon/config"
      - "SPRING_PROFILES_ACTIVE=<%= @dukecon_instance_name %>,postgresql,docker"
    networks:
      - default
      - inspectit
      - monitoring
    ports:
      - "127.0.0.1:<%= @dukecon_instance_feedback_port %>:8090"
    volumes:
      - "/data/dukecon/<%= @dukecon_instance_name %>/feedback/cache:/opt/dukecon/cache"
      - "/data/dukecon/<%= @dukecon_instance_name %>/feedback/config:/opt/dukecon/config"
      - "/data/dukecon/<%= @dukecon_instance_name %>/feedback/heapdumps:/opt/dukecon/heapdumps"
      - "/data/dukecon/<%= @dukecon_instance_name %>/feedback/logs:/opt/dukecon/logs"
      - "/opt/inspectit:/opt/inspectit"
      - "/etc/ssl/certs/java/cacerts:/etc/ssl/certs/java/cacerts"
<% end -%>

  dukecon-edge:
    image: dukecon/dukecon-httpd-edge:<%= @dukecon_instance_label %>
    restart: always
    depends_on:
      - dukecon-pwa
      - dukecon-server
<% if @dukecon_instance_feedback_port != "" -%>
      - dukecon-feedback
<% end -%>
    ports:
      - "127.0.0.1:<%= @dukecon_instance_server_port %>:80"
    volumes:
      - "/data/dukecon/<%= @dukecon_instance_name %>/htdocs:/usr/local/apache2/htdocs"

  autoheal:
    restart: always
    image: willfarrell/autoheal
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
