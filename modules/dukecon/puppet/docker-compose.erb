version: "2"

services:
  dukecon-pwa:
    image: dukecon/dukecon-pwa:<%= @dukecon_instance_label %>
    restart: always

  dukecon-admin-client:
    image: dukecon/dukecon-admin-client:<%= @dukecon_instance_label %>
    restart: always

  dukecon-postgres:
    image: "postgres:<%= @dukecon_postgres_version %>"
    restart: always
    environment:
      - "POSTGRES_USER=dukecon"
      - "POSTGRES_PASSWORD=dukecon"
    ports:
      - "127.0.0.1:<%= @dukecon_instance_postgres_port %>:5432"
    volumes:
      - "/data/dukecon/<%= @dukecon_instance_name %>/postgresql/data:/var/lib/postgresql/data"

  dukecon-server:
    image: dukecon/dukecon-server:<%= @dukecon_instance_label %>
    restart: always
    depends_on:
      - dukecon-postgres
    links:
      - dukecon-postgres:postgres
    environment:
      - "JAVA_OPTS=-XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/dukecon/heapdumps"
      - "SPRING_CONFIG_LOCATION=/opt/dukecon/config"
      - "SPRING_PROFILES_ACTIVE=<%= @dukecon_instance_name %>,postgresql,docker"
    ports:
      - "127.0.0.1:<%= @dukecon_instance_internal_port %>:8080"
    volumes:
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/cache:/opt/dukecon/cache"
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/config:/opt/dukecon/config"
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/heapdumps:/opt/dukecon/heapdumps"
      - "/data/dukecon/<%= @dukecon_instance_name %>/server/logs:/opt/dukecon/logs"

  dukecon-edge:
    image: dukecon/dukecon-httpd-edge:<%= @dukecon_instance_label %>
    restart: always
    depends_on:
      - dukecon-pwa
      - dukecon-server
    ports:
      - "127.0.0.1:<%= @dukecon_instance_server_port %>:80"
